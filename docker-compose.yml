version: "3.9"

services:
  api:
    build: .
    image: stokes-rest-api:dev
    env_file:
      - .env
    environment:
      - NETWORK_TYPE=${NETWORK_TYPE:-testnet}
      - KASPAD_HOST_1=${KASPAD_HOST_1:-host.docker.internal:17210}
      - DISABLE_PRICE=${DISABLE_PRICE:-true}
      - DEBUG=${DEBUG:-true}
      - PREV_OUT_RESOLVED=${PREV_OUT_RESOLVED:-false}
      - USE_SCRIPT_FOR_ADDRESS=${USE_SCRIPT_FOR_ADDRESS:-false}
    ports:
      - "8000:8000"
    restart: unless-stopped
    # Uncomment if you enable SQL_URI and want DB-backed endpoints
    # depends_on:
    #   - postgres

  wrpc-proxy:
    image: supertypo/rusty-kaspa-wrpc-proxy:nightly
    command: >
      kaspa-wrpc-proxy
      ${WRPC_NETWORK_FLAG:-}
      ${WRPC_VERBOSE_FLAG:-}
      --encoding ${WRPC_ENCODING:-borsh}
      --interface ${WRPC_LISTEN_ADDR:-0.0.0.0:17112}
      ${WRPC_GRPC_URL:-grpc://host.docker.internal:17110}
    environment:
      - RUST_LOG=${WRPC_RUST_LOG:-info}
    ports:
      - "17112:17112"
    restart: unless-stopped
    profiles: ["indexer"]

  # Optional: Postgres for indexer-backed endpoints (address history, etc.)
  postgres:
    image: postgres:16
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    profiles: ["db"]

  # Optional: Simply Kaspa Indexer (requires WRPC ws:// to node)
  # Enable only if your Stokes node exposes WRPC (typically 17110)
  indexer:
    build: .
    image: stokes-native-indexer:dev
    command: poetry run python stokesIndexer.py
    env_file:
      - .env
    environment:
      - NETWORK_TYPE=${NETWORK_TYPE:-testnet}
      - KASPAD_HOST_1=${KASPAD_HOST_1:-host.docker.internal:17210}
      - SQL_URI=${SQL_URI:-postgresql+asyncpg://postgres:postgres@postgres:5432/postgres}
      - SQL_URI_BLOCKS=${SQL_URI_BLOCKS:-postgresql+asyncpg://postgres:postgres@postgres:5432/postgres}
      - DEBUG=${DEBUG:-true}
      - USE_SCRIPT_FOR_ADDRESS=${USE_SCRIPT_FOR_ADDRESS:-false}
      - INDEXER_POLL_SECONDS=${INDEXER_POLL_SECONDS:-2}
      - INDEXER_BATCH_LIMIT=${INDEXER_BATCH_LIMIT:-0}
    depends_on:
      - postgres
    restart: unless-stopped
    profiles: ["indexer"]

volumes:
  pgdata:
